
<!DOCTYPE html>
<html>
    <head>
        <title>Django, SQLite and writes - Tomi's Blog</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf8" />
    <meta name="description" content="Home of Tomi Mickelsson and blog about tech"/>


    <meta content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" name="viewport" />


    <link rel="shortcut icon" href="/static/favicon.ico" />

    <link rel="apple-touch-icon" type="image/png" href="/static/applehome-tomi.png" />


    <link rel="stylesheet" href="/static/main.css" type="text/css" />
    <link rel="stylesheet" href="/static/pastie.css" type="text/css" />

    <link rel="stylesheet" href="/static/mobile.css" type="text/css" />

    <link rel="stylesheet" href="/static/full.css" type="text/css" />



<!--[if lte IE 8]>
    <link rel="stylesheet" type="text/css" href="/static/ie.css"/>
<![endif]-->









<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30210642-1']);
  _gaq.push(['_setDomainName', 'tomicloud.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    </head>
    <body>

    <div id="header">
        


        <a id="logo" title="Home" href="/">&nbsp;</a>
        <p>Tomi's blog about tech</p>


        <div class="nav">
            <a href="/" class="icon " >
                <span id="icohome">&nbsp;</span>Blog</a>
            <a href="/work" class="icon ">
                <span id="icowork">&nbsp;</span>Work</a>
            <a href="/about" class="icon ">
                <span id="icoabout">&nbsp;</span>About</a>
        </div>
    </div>

    <div id="sidebar">
        <div>

            <p class="mypic">


            <img src="/static/tomimickelsson.png" title="Tomi Mickelsson" />
            </p>

            <p class="colorize">
            Tomi is a software engineer working as a freelance consultant in
            <span>HTML5</span> and <span>mobile</span> projects.





            </p>
























<p><a class="icon" href="http://twitter.com/tomimickelsson">
    <span id="icotwitter">&nbsp;</span> twitter</a></p>
<p><a class="icon" href="mailto:tomi.mickelsson@iki.fi">
    <span id="icoenve">&nbsp;</span> tomi.mickelsson@iki.fi</a></p>





            <h3>Blog Posts</h3>
            
            <p class="plink"><a class=""
         href="/2014/01/responsive-gallery" >Responsive HTML5 image gallery tutorial</a></p>
            
            <p class="plink"><a class=""
         href="/2013/11/mapcolorizer" >Mapcolorizer.js: Choropleth maps with Leaflet</a></p>
            
            <p class="plink"><a class=""
         href="/2013/01/js-jquery-boilerplates" >My favorite Javascript + jQuery boilerplates</a></p>
            
            <p class="plink"><a class=""
         href="/2012/11/screenshot-fetcher" >Android &amp; iOS screenshot fetcher</a></p>
            
            <p class="plink"><a class=""
         href="/2012/07/viewsrc-chrome-ext" >Quick source viewer - Chrome extension</a></p>
            
            <p class="plink"><a class=""
         href="/2012/04/save-css-chrome-ext" >Save CSS - Chrome extension makes you fly</a></p>
            
            <p class="plink"><a class=""
         href="/2012/03/multi-touch-demo" >Multi-touch events playground</a></p>
            
            <p class="plink"><a class="sel"
        >Django, SQLite and writes</a></p>
            
            <p class="plink"><a class=""
         href="/2012/02/tech-stack" >Tech stack of my blog</a></p>
            
            <p class="plink"><a class=""
         href="/2012/02/hello-world" >Hello World!</a></p>
            





        </div>

        


       

    </div>

    <div id="page">
        






<div class="post">
    <h1>Django, SQLite and writes</h1>

    

    <div class="date">Feb 18, 2012
    </div>

    

    <p><img src="/static/sqlite-write.png" class="title" /></p>
<p>There seems to be some confusion about whether the SQLite embedded database
has transactions and how it handles simultaneous writes from multiple processes.</p>
<ol>
<li>SQLite <a href="http://www.sqlite.org/transactional.html">does support transactions</a>. It has proper <code>ACID</code> functionality.</li>
<li>Multiple simultaneous writes are not supported. A write operation locks the
whole database file for the duration of the transaction. Other write operations are put into waiting queue with a timeout.</li>
<li>Simultaneous reads can proceed even with an active write transaction.</li>
</ol>
<p>Let's perform a simple test with read and write operations in Django and SQLite:</p>
<div class="codehilite"><pre><span class="c"># settings.py</span>
<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="s">&#39;/home/tomi/djangotest.sqlite&#39;</span><span class="p">,</span>
        <span class="s">&#39;USER&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>              <span class="c"># Not used with sqlite3.</span>
        <span class="s">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>          <span class="c"># Not used with sqlite3.</span>
        <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>              <span class="c"># Not used with sqlite3.</span>
        <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>              <span class="c"># Not used with sqlite3.</span>
        <span class="c"># for sqlite write lock timeout</span>
        <span class="s">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;timeout&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c"># urls.py</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;testread$&#39;</span><span class="p">,</span> <span class="s">&#39;myapp.views.testread&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;testwrite$&#39;</span><span class="p">,</span> <span class="s">&#39;myapp.views.testwrite&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;testwritelong$&#39;</span><span class="p">,</span> <span class="s">&#39;myapp.views.testwritelong&#39;</span><span class="p">),</span>
    <span class="c">#...</span>

<span class="c"># models.py</span>
<span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span>   <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c"># views.py</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">Dummy</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">testread</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># read dummy objects</span>
    <span class="n">dummylist</span> <span class="o">=</span> <span class="n">Dummy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;test read&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">testwrite</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># create a dummy object, short transaction</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;t1&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;test write&quot;</span><span class="p">)</span>
<span class="nd">@transaction.commit_on_success</span>
<span class="k">def</span> <span class="nf">testwritelong</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># this code executes inside a transaction for 10s</span>
    <span class="n">_debug</span><span class="p">(</span><span class="s">&quot;testlongwrite&quot;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;t2&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">_debug</span><span class="p">(</span><span class="s">&quot;testlongwrite 2&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;test long write&quot;</span><span class="p">)</span>
</pre></div>


<p>Now run the server in an environment with multiple request processes. <code>The
Django
development server "python manage.py runserver" won't do</code> because it only runs a single process. I'm using <a href="http://projects.unbit.it/uwsgi/">uWSGI</a> for my projects.</p>
<p>Launch a browser and open three tabs to urls:
"localhost:8000/testread",
"localhost:8000/testwrite" and
"localhost:8000/testwritelong".</p>
<p>A normal Django model write operation is quick. Each <code>model.save()</code>
is wrapped inside a short-lived transaction. Database locking is thus not a
big problem. To test how the database gets locked during a long write
transaction, invoke <strong>'testwritelong'</strong> and then simultaneously another
'testwrite'. As you can see, the second write has to wait until the first
write completes. After 5 seconds, the timeout will expire and Django throws a
<a href="https://docs.djangoproject.com/en/dev/ref/databases/">"Database is locked"
error</a>. 'testread' works
fine even with a long 'testwritelong'. You can set a longer wait timeout in
settings.py.</p>
<p>Django and SQLite work fine in small web projects that run in a single
machine, and no data gets lost with moderate write activity and even with
longer transactions. However, when you run multiple servers, use a
server-based database, as SQLite may have trouble when <a href="http://www.sqlite.org/lockingv3.html">run over network
filesystem</a>.</p>

    <p class="author">&mdash; Tomi Mickelsson</p>













    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'tomicloud'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>









    </div>

    <div id="footer">



    <p>
    <a class="icon" href="http://twitter.com/tomimickelsson"><span id="icotwitter">&nbsp;</span> twitter</a> |
    <a class="icon" href="mailto:tomi.mickelsson@iki.fi"><span id="icoenve">&nbsp;</span> tomi.mickelsson@iki.fi</a>

    </p>

    <p>&copy; 2015 Tomi Mickelsson</p>

    </div>
    </div>














</body>


    

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    
    <script src="/static/main.js"></script>


<script type="text/javascript">
    $(document).ready(function(){
        MAIN.main();
    });
</script>









</html>

